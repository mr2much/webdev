<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weather Here</title>
  </head>
  <body>
    <div><a href="/">check in</a> | <a href="/list">view checkins</a></div>

    <h1>The Weather Here</h1>

    <p>
      <strong>Latitude: </strong><span id="lat"></span>&deg;
      <strong>Longitude: </strong><span id="lon"></span>&deg; <br />
      <strong>Condition: </strong><span id="condition"></span>
      <img id="icon" /> <br />
      <strong>Temperature: </strong><span id="celsius"></span>&deg; C<br />
      <strong>Location: </strong><span id="name"></span>,
      <span id="country"></span><br />
      <strong>Last Updated: </strong><span id="last"></span>
    </p>

    <div id="airq">
      <h3>Air Quality Measurements:</h3>
    </div>

    <button id="submit">Check In</button>

    <div>
      <p>
        <a href="https://www.weatherapi.com/" title="Free Weather API"
          ><img
            src="//cdn.weatherapi.com/v4/images/weatherapi_logo.png"
            alt="Weather data by WeatherAPI.com"
            border="0"
        /></a>
      </p>

      <p>
        <a href="https://openaq.org/#/" title="OpenAQ">Open Air Quality</a>
      </p>
    </div>

    <script>
      let data;
      getGeolocationInfo();

      async function getGeolocationInfo() {
        let lat, lon;

        // check if geolocation is available
        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(async (position) => {
            lat = position.coords.latitude;
            lon = position.coords.longitude;

            document.querySelector("#lat").textContent = lat;
            document.querySelector("#lon").textContent = lon;
            data = await getData(lat, lon);

            const weather = data.weather;

            const div = document.querySelector("#airq");

            const air = data.air_quality.results;

            if (air.length > 0) {
              air.forEach((result) => {
                let ul = document.createElement("ul");
                ul.innerHTML = `<strong>Sensor: </strong> ${result.location}`;

                result.measurements.forEach((measurement) => {
                  let li = document.createElement("li");
                  li.innerHTML = `<strong>${measurement.parameter.toUpperCase()}: </strong>${
                    measurement.value
                  } ${measurement.unit}`;
                  ul.append(li);
                });

                div.append(ul);
              });
            } else {
              let p = document.createElement("p");
              p.textContent = "No measurements";
              div.append(p);
            }

            const text = weather.current.condition.text;

            document.querySelector("#condition").textContent = text;
            const img = document.querySelector("#icon");
            img.src = weather.current.condition.icon;
            img.alt = text;

            document.querySelector("#celsius").textContent =
              weather.current.temp_c;

            document.querySelector("#name").textContent = weather.location.name;
            document.querySelector("#country").textContent =
              weather.location.country;
            document.querySelector("#last").textContent =
              weather.current.last_updated;
          });
        } else {
          console.log("No geolocation data available");
        }
      }

      async function getData(lat, lon) {
        const res = await fetch(`/weather/${lat},${lon}`);

        const json = await res.json();

        return json;
      }
    </script>
  </body>
</html>
